#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2

# Ensure the .apt directory exists
if [ -d "$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu" ]; then
  echo "Copying libraries to $BUILD_DIR/.heroku/vendor/lib"
  mkdir -p $BUILD_DIR/.heroku/vendor/lib
  cp -r $BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu/* $BUILD_DIR/.heroku/vendor/lib/

  # Set LD_LIBRARY_PATH during build
  export LD_LIBRARY_PATH=$BUILD_DIR/.heroku/vendor/lib:$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
  echo "LD_LIBRARY_PATH is set to $LD_LIBRARY_PATH"

  # Create a profile script to set LD_LIBRARY_PATH at runtime
  mkdir -p $BUILD_DIR/.profile.d
  echo "export LD_LIBRARY_PATH=$BUILD_DIR/.heroku/vendor/lib:\$LD_LIBRARY_PATH" > $BUILD_DIR/.profile.d/libxmlsec1.sh
else
  echo "Directory $BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu does not exist"
fi

# Run the application's bin/compile script if it exists
if [ -f "$BUILD_DIR/bin/compile" ]; then
  echo "Running application's bin/compile script"
  $BUILD_DIR/bin/compile $BUILD_DIR $CACHE_DIR
else
  echo "Application's bin/compile script not found"
fi